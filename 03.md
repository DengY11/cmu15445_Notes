# cmu15445 03

 ## 操作系统的内存页，mmap技术
 ### 内存映射文件（mmap）和内存页概述
 #### mmap：
 - 内存映射文件是一种将文件内容直接映射到进程的虚拟地址技术。使用mmap，文件内容可以像内存一样被快速访问，可不需要显示的**I/O**操作。
#### 内存页：
  - 操作系统将内存划分为固定大小的块，称为**页(page)**。内存页是虚拟内存管理的基本单位。
#### 数据库的优化：
  - 数据库为了效率，避免直接调用操作系统的的内存api和mmap(*早期的数据库普遍认为mmap是合适的技术，但后来选择放弃*)，而是自己实现了一套内存管理机制。这种机制包括将内存分页，并通过缓冲池技术减少反复的**I/O**操作

## 数据库内存页的插槽式设计
 - **插槽设计**：内存页采用插槽(slotted pages) 设计，包括以下部分：
![](./03%20picture/slot.png)
    - **Header**：记录页的总体信息，包括已用插槽的数量，最后一个插槽的起始位置等信息。
    - **Slot Array**：存储指针，每个指针指向数据(**tuple**)在这个内存页的位置。
    - **Tuple Storage**：实际存储的数据，从内存页的另一个方向存储。
- 这种设计的优势在于，当我们删除某个数据时，后面的数据不会前移，减少了数据移动的开销。新增数据时，也不会利用空出来的位置，而是在末尾添加新数据，这种情况下会产生碎片空间，需要定期进行空间回收(**vacuum**)操作。
* 注意：不同的数据库的具体情况可能不同
## 示例操作
### 初始状态
- ctid是行位置
- 最开始有3个tuple，储存在第0页的第1，2，3，个slot：
![初始状态](./03%20picture/1.png)
### 删除操作
- 删除id = 101 的数据，发现后面的数据并没有前移，插槽(0,2)变为空。
![删除操作](./03%20picture/2.png)
### 插入操作
- 插入一个新数据，发现并没投有用(0，2)的位置，而是在后面添加新的slot。
![插入操作](./03%20picture/3.png)
### VACUUM
- 运行**VACUUM FULL**回收空间，后面的数据前移。
![vacuum](./03%20picture/4.png)

