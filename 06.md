# CMU15445 06
## 缓冲池(buffer pools)
### 1.引言
DBMS负责管理内存并在**磁盘和内存**之间**移动**数据。因为数据不能直接在磁盘上操作，所以数据库必须能够高效地将表示为文件的数据从磁盘移动到内存，以便使用。理想情况下，从**执行引擎**（execution engine）的角度来看，所有数据都应该“看起来”在内存中，无需担心如何将数据提取到内存。
<img src="./06 pictrue/1.png" alt="图片描述" width="500" height="250">
- **空间控制（Spatial Control）**：指的是页面在磁盘上的物理写入位置。目标是将经常一起使用的页面在磁盘上尽可能**靠近**。
- **时间控制（Temporal Control）**：指的是何时将页面读入内存以及何时将其写回磁盘。目标是**最小化**由于从磁盘读取数据而导致的**停顿**。

### 2. 锁与闩（Locks vs. Latches）
- **锁（Locks）**：**高层次**的逻辑原语，用于保护**数据库内容**（如元组、表、数据库）不被其他事务访问。事务在其整个持续时间内都会持有锁。数据库系统可以向用户公开运行查询时所持有的锁。锁需要能够回滚更改。
- **闩（Latches）**：**低层次**的保护原语，DBMS用于其内部**数据结构**的关键部分（如哈希表、内存区域）。闩只在操作持续期间持有，不需要回滚更改。

### 3. 缓冲池（Buffer Pool）
缓冲池是从磁盘读取页面的内存缓存。它是数据库中分配的一个大内存区域，用于**存储从磁盘提取的页面**。缓冲池的内存区域组织为固定大小*内存页(page)* 的数组，每个数组条目称为一个**帧**（frame）。

- **页面请求(request a page)**：请求页面时，数据库系统首先搜索缓冲池，如果未找到页面，系统会从磁盘获取该页面的副本。
- **脏页面(dirt page)**：修改过的页面不会立即写回磁盘，而是暂时缓存在缓冲池中。

#### 缓冲池元数据
为了高效和正确地使用缓冲池，必须维护某些**元数据(meta-data)**：
- **页面表（Page Table）**：一个内存中的哈希表，跟踪当前在内存中的页面。它将**页面ID**映射到缓冲池中的**frame位置**。
<img src="./06 pictrue/2.png" alt="图片描述" width="500" height="250">
- **脏标志（Dirty-Flag）**：线程在修改页面时设置脏标志，指示存储管理器必须将页面**写回磁盘**。
- **引脚/引用计数器（Pin/Reference Counter）**：跟踪当前访问该页面的线程数。线程在访问页面前必须增加计数器。如果页面的引脚计数大于零，则存储管理器**不允许**将该页面从内存中逐出。
#### 内存分配策略
- **全局策略**：DBMS为整个工作负载做出有利决策，考虑所有活动事务以找到分配内存的最佳决策。
- **局部策略**：做出使单个查询或事务运行更快的决策，即使这对整个工作负载不利。局部策略为特定事务分配框架，而不考虑并发事务的行为。
- **组合使用**：大多数系统使用全局和局部视图的组合。

### 5. 缓冲替换策略
当DBMS需要腾出框架空间以容纳新页面时，必须决定从缓冲池中逐出哪个页面。替换策略是一种算法，DBMS实现该算法以决定在需要空间时逐出缓冲池中的哪个页面。

- **最近最少使用（LRU）**：维护每个页面上次访问的时间戳，选择时间戳最旧的页面进行逐出。
- **时钟（CLOCK）**：LRU的近似算法，每个页面有一个引用位。访问页面时，引用位设置为1。组织页面为一个圆形缓冲区，检查页面的引用位，如果为1则重置为0，如果为0则逐出。
<img src="./06 pictrue/3.png" alt="图片描述" width="800" height="250">
- **替代策略**：
  - **LRU-K**：跟踪最后K次引用的历史记录，预测页面下次访问的时间。
  - **查询本地化**：DBMS按事务/查询基础选择要逐出的页面，最小化每个查询对缓冲池的污染。
  - **优先级提示**：事务告诉缓冲池页面的重要性，基于查询执行期间每个页面的上下文。

#### 脏页面处理
- **最快方法**：删除缓冲池中所有非脏页面。

- **较慢方法**：将脏页面写回磁盘以确保其更改持久化。

- **后台写入**：DBMS定期遍历页面表并将脏页面写入磁盘。


### 6. 其他内存池
DBMS需要内存用于元组和索引以外的其他用途。这些内存池可能不一定由磁盘支持，具体取决于实现。

- **排序和连接缓冲**
- **查询缓存**
- **维护缓冲**
- **日志缓冲**
- **字典缓存**

### 7. 操作系统页面缓存
大多数磁盘操作通过操作**系统API**进行。除非明确另有说明，否则操作系统会维护自己的文件系统缓存。大多数DBMS使用直接I/O**绕过**操作系统的缓存，以避免页面的冗余副本并管理不同的逐出策略。

*PostgreSQL是一个使用操作系统页面缓存的数据库系统示例。*
### 8. 磁盘I/O调度
DBMS维护内部队列来跟踪整个系统的页面读/写请求。任务的优先级基于以下几个因素确定：

- **顺序I/O vs. 随机I/O**
- **关键路径任务 vs. 后台任务**
- **表 vs. 索引 vs. 日志 vs. 临时数据**
- **事务信息**
- **基于用户的服务级别协议（SLAs）**

通过这些措施，DBMS可以更高效地管理磁盘和内存之间的数据传输，从而提高整体性能和响应速度。